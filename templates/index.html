<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t('title') }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#475569',
                    }
                }
            }
        }
    </script>
    <style>
        .dark {
            background-color: #111827;
            color: #f3f4f6;
        }
        .dark .bg-white {
            background-color: #1f2937;
        }
        .dark .text-gray-700 {
            color: #f3f4f6;
        }
        .dark .border-gray-200 {
            border-color: #374151;
        }
        .dark .bg-gray-50 {
            background-color: #374151;
        }
        .dark .bg-gray-100 {
            background-color: #1f2937;
        }
        .dark .bg-blue-100 {
            background-color: #1e40af;
            color: #ffffff;
        }
        .dark .bg-green-100 {
            background-color: #065f46;
            color: #ffffff;
        }
        .dark .bg-red-100 {
            background-color: #991b1b;
            color: #ffffff;
        }
        .dark .hover\:bg-gray-50:hover {
            background-color: #374151;
        }
        .dark .hover\:bg-gray-300:hover {
            background-color: #4b5563;
        }
        .dark .bg-blue-50 {
            background-color: #1e40af;
            color: #ffffff;
        }
        .dark .text-blue-600 {
            color: #93c5fd;
        }
        .dark .text-gray-500 {
            color: #d1d5db;
        }
        .dark .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: #374151;
        }
        .dark .border-gray-300 {
            border-color: #4b5563;
        }
        .dark .bg-gray-200 {
            background-color: #374151;
        }
        .dark .bg-gray-700 {
            background-color: #4b5563;
        }
        .dark .hover\:bg-gray-600:hover {
            background-color: #6b7280;
        }
        /* Fix for table backgrounds */
        .dark tbody.bg-white {
            background-color: #1f2937 !important;
        }
        .dark thead.bg-gray-50 {
            background-color: #374151 !important;
        }
        /* Fix for text colors in dark mode */
        .dark .text-gray-900 {
            color: #f3f4f6 !important;
        }
        .dark .text-gray-700 {
            color: #e5e7eb !important;
        }
        /* Fix for input and select backgrounds */
        .dark input, .dark select {
            background-color: #374151 !important;
            color: #f3f4f6 !important;
            border-color: #4b5563 !important;
        }
        .dark input::placeholder {
            color: #9ca3af !important;
        }
        /* Fix for pagination */
        .dark .bg-white.px-4 {
            background-color: #1f2937 !important;
        }
        .dark .text-gray-700 {
            color: #e5e7eb !important;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">{{ t('title') }}</h1>
            <div class="space-x-4">
                <select onchange="window.location.href='/set_language/' + this.value" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded">
                    <option value="fi" {% if lang == 'fi' %}selected{% endif %}>Suomi</option>
                    <option value="en" {% if lang == 'en' %}selected{% endif %}>English</option>
                </select>
                <button onclick="toggleTheme()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded">{{ t('toggle_theme') }}</button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">{{ t('statistics') }}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="p-4 bg-blue-100 rounded">
                    <h3 class="font-semibold">{{ t('total_studies') }}</h3>
                    <p class="text-2xl">{{ total_studies }}</p>
                </div>
                <div class="p-4 bg-green-100 rounded">
                    <h3 class="font-semibold">{{ t('total_classifications') }}</h3>
                    <p class="text-2xl">{{ total_classifications }}</p>
                </div>
            </div>
            
            <div class="mt-6">
                <h3 class="font-semibold mb-4">{{ t('classification_metrics') }}</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <div class="p-2 bg-green-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('true_positive') }}</h4>
                        <p class="text-xl">{{ tp_count }}</p>
                    </div>
                    <div class="p-2 bg-green-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('true_negative') }}</h4>
                        <p class="text-xl">{{ tn_count }}</p>
                    </div>
                    <div class="p-2 bg-red-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('false_positive') }}</h4>
                        <p class="text-xl">{{ fp_count }}</p>
                    </div>
                    <div class="p-2 bg-red-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('false_negative') }}</h4>
                        <p class="text-xl">{{ fn_count }}</p>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <h3 class="font-semibold mb-4">{{ t('performance_metrics') }}</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('sensitivity') }}</h4>
                        <p class="text-xl">{{ "%.1f"|format(sensitivity) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('specificity') }}</h4>
                        <p class="text-xl">{{ "%.1f"|format(specificity) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('accuracy') }}</h4>
                        <p class="text-xl">{{ "%.1f"|format(accuracy) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('ppv') }}</h4>
                        <p class="text-xl">{{ "%.1f"|format(ppv) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('npv') }}</h4>
                        <p class="text-xl">{{ "%.1f"|format(npv) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('f1_score') }}</h4>
                        <p class="text-xl">{{ "%.1f"|format(f1_score) }}%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">{{ t('filters') }}</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <select id="timeFilter" class="border rounded p-2">
                    <option value="all" {% if time_filter == 'all' %}selected{% endif %}>{{ t('all_time') }}</option>
                    <option value="today" {% if time_filter == 'today' %}selected{% endif %}>{{ t('today') }}</option>
                    <option value="week" {% if time_filter == 'week' %}selected{% endif %}>{{ t('last_week') }}</option>
                    <option value="month" {% if time_filter == 'month' %}selected{% endif %}>{{ t('last_month') }}</option>
                </select>
                <input type="text" id="studyType" placeholder="{{ t('study_type') }}" class="border rounded p-2" value="{{ study_type if study_type else '' }}">
                <select id="resultType" class="border rounded p-2">
                    <option value="" {% if not result_type %}selected{% endif %}>{{ t('all_results') }}</option>
                    <option value="CLASSIFIED" {% if result_type == 'CLASSIFIED' %}selected{% endif %}>{{ t('classified_cases') }}</option>
                    <option value="MY_CLASSIFIED" {% if result_type == 'MY_CLASSIFIED' %}selected{% endif %}>{{ t('my_classified_cases') }}</option>
                    <option value="TP" {% if result_type == 'TP' %}selected{% endif %}>{{ t('true_positive') }}</option>
                    <option value="TN" {% if result_type == 'TN' %}selected{% endif %}>{{ t('true_negative') }}</option>
                    <option value="FP" {% if result_type == 'FP' %}selected{% endif %}>{{ t('false_positive') }}</option>
                    <option value="FN" {% if result_type == 'FN' %}selected{% endif %}>{{ t('false_negative') }}</option>
                    <option value="DOUBT" {% if result_type == 'DOUBT' %}selected{% endif %}>{{ t('doubt') }}</option>
                </select>
                <div class="flex items-center space-x-2">
                    <select id="username" class="border rounded p-2 flex-grow">
                        <option value="">{{ t('select_username') }}</option>
                        {% for username in usernames %}
                        <option value="{{ username }}" {% if username == selected_username %}selected{% endif %}>{{ username }}</option>
                        {% endfor %}
                    </select>
                    <input type="text" id="newUsername" placeholder="{{ t('new_username') }}" class="border rounded p-2 flex-grow hidden">
                    <button onclick="toggleNewUsername()" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 rounded">+</button>
                </div>
            </div>
            <div class="mt-4 flex gap-2">
                <button onclick="resetFilters()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">
                    {{ t('reset_filters') }}
                </button>
                <button onclick="window.location.reload()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">
                    Päivitä
                </button>
            </div>
        </div>

        <!-- Studies Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('date') }}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('accession_number') }}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('study_description') }}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('ai_classification') }}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('user_classification') }}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('follow_up_classification') }}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('actions') }}</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for study in studies.items %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            {{ study.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            <a href="javascript:void(0)" 
                               onclick="openPACSViewer('{{ study.accession_number }}')"
                               class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                                {{ study.accession_number }}
                            </a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            {{ study.study_description }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if study.ai_classification in ['TP', 'FP'] %}
                                {{ t('positive') }}
                            {% elif study.ai_classification in ['TN', 'FN'] %}
                                {{ t('negative') }}
                            {% elif study.ai_classification == 'DOUBT' %}
                                {{ t('doubt') }}
                            {% else %}
                                {{ study.ai_classification }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% set user_class = study.classifications|selectattr('classification_type', 'equalto', 'USER')|list %}
                            {% if user_class and user_class|length > 0 %}
                                {% set last_user = user_class|last %}
                                {% if last_user.classification in ['TP', 'FN'] %}
                                    {{ t('positive') }}
                                {% elif last_user.classification in ['TN', 'FP'] %}
                                    {{ t('negative') }}
                                {% else %}
                                    {{ last_user.classification }}
                                {% endif %}
                            {% else %}
                                <!-- No user classification -->
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% set follow_up_class = study.classifications|selectattr('classification_type', 'equalto', 'FOLLOW_UP')|list %}
                            {% if follow_up_class and follow_up_class|length > 0 %}
                                {% set last_follow_up = follow_up_class|last %}
                                {% if last_follow_up.classification in ['TP', 'FN'] %}
                                    {{ t('positive') }}
                                {% elif last_follow_up.classification in ['TN', 'FP'] %}
                                    {{ t('negative') }}
                                {% else %}
                                    {{ last_follow_up.classification }}
                                {% endif %}
                            {% else %}
                                <!-- No follow-up classification -->
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex flex-col">
                                {% set user_class = study.classifications|selectattr('classification_type', 'equalto', 'USER')|list %}
                                {% set last_user = user_class|last if user_class else None %}
                                {% set follow_up = study.classifications|selectattr('classification_type', 'equalto', 'FOLLOW_UP')|list %}
                                {% set last_follow_up = follow_up|last if follow_up else None %}
                                <select id="classification_{{ study.id }}" onchange="classifyStudy({{ study.id }}, this.value)" class="border rounded p-1 bg-white dark:bg-gray-700 mb-2">
                                    <option value="" {% if not last_user and not last_follow_up %}selected{% endif %}>{{ t('select_classification') }}</option>
                                    <optgroup label="{{ t('user_classification') }}">
                                        <option value="USER_POSITIVE" {% if last_user and last_user.classification in ['TP', 'FN'] %}selected{% endif %}>{{ t('positive') }}</option>
                                        <option value="USER_NEGATIVE" {% if last_user and last_user.classification in ['TN', 'FP'] %}selected{% endif %}>{{ t('negative') }}</option>
                                    </optgroup>
                                    <optgroup label="{{ t('follow_up_classification') }}">
                                        <option value="FOLLOW_UP_POSITIVE" {% if not last_user and last_follow_up and last_follow_up.classification in ['TP', 'FN'] %}selected{% endif %}>{{ t('positive') }}</option>
                                        <option value="FOLLOW_UP_NEGATIVE" {% if not last_user and last_follow_up and last_follow_up.classification in ['TN', 'FP'] %}selected{% endif %}>{{ t('negative') }}</option>
                                    </optgroup>
                                    <option value="REMOVE_USER">Poista käyttäjän luokittelu</option>
                                    <option value="REMOVE_FOLLOW_UP">Poista jatkotutkimuksen luokittelu</option>
                                </select>
                                <div id="comment-section-{{ study.id }}" style="max-width: 350px; word-break: break-word;">
                                    <div id="latest-comment-{{ study.id }}" class="text-xs text-gray-600 mb-1"></div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <input type="text" id="new-comment-input-{{ study.id }}" class="border rounded text-xs px-1 py-0.5 w-full" placeholder="Lisää kommentti..." onfocus="expandCommentInput({{ study.id }})" style="max-width: 120px;" />
                                        <button class="text-blue-600 text-xs whitespace-nowrap" onclick="showAllComments({{ study.id }})">Näytä kommentit</button>
                                    </div>
                                    <div id="comment-textarea-wrapper-{{ study.id }}" class="hidden flex flex-col gap-1" style="max-width: 100%;">
                                        <textarea id="new-comment-textarea-{{ study.id }}" class="border rounded p-1 w-full text-sm" rows="3" placeholder="Lisää kommentti..." style="resize: vertical; max-width: 100%;"></textarea>
                                        <div class="flex gap-2 mt-1">
                                            <button class="bg-blue-600 text-white text-xs px-2 py-1 rounded" onclick="saveComment({{ study.id }})">Tallenna</button>
                                            <button class="bg-gray-300 text-gray-800 text-xs px-2 py-1 rounded" onclick="shrinkCommentInput({{ study.id }})">Peruuta</button>
                                        </div>
                                        <button class="text-blue-600 text-xs mt-1 block w-full text-left" onclick="showAllComments({{ study.id }})">Näytä kommentit</button>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Pagination -->
            {% if studies.pages > 1 %}
            <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                <div class="flex-1 flex justify-between sm:hidden">
                    {% if studies.has_prev %}
                    <a href="?page={{ studies.prev_num }}{% if time_filter != 'all' %}&time_filter={{ time_filter }}{% endif %}{% if study_type %}&study_type={{ study_type }}{% endif %}{% if result_type %}&result_type={{ result_type }}{% endif %}{% if selected_username %}&username={{ selected_username }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        {{ t('previous') }}
                    </a>
                    {% endif %}
                    {% if studies.has_next %}
                    <a href="?page={{ studies.next_num }}{% if time_filter != 'all' %}&time_filter={{ time_filter }}{% endif %}{% if study_type %}&study_type={{ study_type }}{% endif %}{% if result_type %}&result_type={{ result_type }}{% endif %}{% if selected_username %}&username={{ selected_username }}{% endif %}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        {{ t('next') }}
                    </a>
                    {% endif %}
                </div>
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700">
                            {{ t('showing') }} <span class="font-medium">{{ (page - 1) * 100 + 1 }}</span> {{ t('to') }} <span class="font-medium">{{ min(page * 100, studies.total) }}</span> {{ t('of') }} <span class="font-medium">{{ studies.total }}</span> {{ t('results') }}
                        </p>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            {% if studies.has_prev %}
                            <a href="?page={{ studies.prev_num }}{% if time_filter != 'all' %}&time_filter={{ time_filter }}{% endif %}{% if study_type %}&study_type={{ study_type }}{% endif %}{% if result_type %}&result_type={{ result_type }}{% endif %}{% if selected_username %}&username={{ selected_username }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                {{ t('previous') }}
                            </a>
                            {% endif %}
                            
                            {% for p in range(1, studies.pages + 1) %}
                                {% if p == page %}
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-50 text-sm font-medium text-blue-600">
                                    {{ p }}
                                </span>
                                {% else %}
                                <a href="?page={{ p }}{% if time_filter != 'all' %}&time_filter={{ time_filter }}{% endif %}{% if study_type %}&study_type={{ study_type }}{% endif %}{% if result_type %}&result_type={{ result_type }}{% endif %}{% if selected_username %}&username={{ selected_username }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    {{ p }}
                                </a>
                                {% endif %}
                            {% endfor %}
                            
                            {% if studies.has_next %}
                            <a href="?page={{ studies.next_num }}{% if time_filter != 'all' %}&time_filter={{ time_filter }}{% endif %}{% if study_type %}&study_type={{ study_type }}{% endif %}{% if result_type %}&result_type={{ result_type }}{% endif %}{% if selected_username %}&username={{ selected_username }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                {{ t('next') }}
                            </a>
                            {% endif %}
                        </nav>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div id="comments-modal" class="fixed z-50 inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-lg max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Kommentit</h3>
                <button onclick="closeCommentsModal()" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="comments-modal-list"></div>
        </div>
    </div>

    <script>
        // Add this function at the beginning of the script section
        function openPACSViewer(accessionNumber) {
            const url = `http://wxturkupacs1.tyks.fi/masterview/mv.jsp?user_name=&server_name=PACS&accession_number=${accessionNumber}`;
            const pacsWindow = window.open(url, 'PACSViewer', 'width=1,height=1,left=0,top=0');
            if (pacsWindow) {
                // Minimize the window immediately
                pacsWindow.blur();
                window.focus();
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
        }

        function toggleNewUsername() {
            const usernameSelect = document.getElementById('username');
            const newUsernameInput = document.getElementById('newUsername');
            
            if (newUsernameInput.classList.contains('hidden')) {
                usernameSelect.classList.add('hidden');
                newUsernameInput.classList.remove('hidden');
                newUsernameInput.focus();
                
                // Add enter key handler when showing the input
                newUsernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const username = newUsernameInput.value.trim();
                        if (username) {
                            // Check if username already exists
                            const existingUsernames = Array.from(usernameSelect.options).map(opt => opt.value.toLowerCase());
                            if (existingUsernames.includes(username.toLowerCase())) {
                                alert('This username already exists. Please choose a different one.');
                                return;
                            }
                            
                            // Add username to database
                            fetch('/api/username', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ username: username })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    // Add the new username to the dropdown
                                    const option = document.createElement('option');
                                    option.value = username;
                                    option.text = username;
                                    usernameSelect.appendChild(option);
                                    usernameSelect.value = username;
                                    
                                    // Switch back to dropdown
                                    toggleNewUsername();
                                    
                                    // Apply filters with new username
                                    applyFilters();
                                } else {
                                    alert('Error: ' + data.error);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('An error occurred while adding the username');
                            });
                        }
                    }
                });
            } else {
                usernameSelect.classList.remove('hidden');
                newUsernameInput.classList.add('hidden');
                newUsernameInput.value = '';
            }
        }

        function getUsername() {
            const usernameSelect = document.getElementById('username');
            const newUsernameInput = document.getElementById('newUsername');
            
            if (!newUsernameInput.classList.contains('hidden')) {
                return newUsernameInput.value.trim();
            }
            return usernameSelect.value;
        }

        function classifyStudy(studyId, classification) {
            if (!classification) return;
            const username = getUsername();
            if (!username) {
                alert('Please select or enter your username before classifying');
                return;
            }
            let classificationType, classificationValue;
            if (classification === 'REMOVE_USER') {
                classificationType = 'USER';
                classificationValue = 'REMOVE';
            } else if (classification === 'REMOVE_FOLLOW_UP') {
                classificationType = 'FOLLOW_UP';
                classificationValue = 'REMOVE';
            } else {
                // Parse the combined value for both user and follow-up
                let parts = classification.split('_');
                if (parts.length === 3) {
                    classificationType = parts[0] + '_' + parts[1];
                    classificationValue = parts[2];
                } else {
                    [classificationType, classificationValue] = parts;
                }
            }
            if (classificationValue === 'REMOVE') {
                if (!confirm('Are you sure you want to remove the ' + (classificationType === 'USER' ? '{{ t('user_classification') }}' : '{{ t('follow_up_classification') }}') + '?')) {
                    return;
                }
            } else {
                if (!confirm('Are you sure you want to classify this study as ' + (classificationValue === 'POSITIVE' ? '{{ t('positive') }}' : '{{ t('negative') }}') + ' (' + (classificationType === 'USER' ? '{{ t('user_classification') }}' : '{{ t('follow_up_classification') }}') + ')?')) {
                    return;
                }
            }
            fetch('/api/classify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    study_id: studyId,
                    username: username,
                    classification: classificationValue,
                    classification_type: classificationType
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to classify study');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // Reset dropdown to default after removal or change
                    document.getElementById('classification_' + studyId).selectedIndex = 0;
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error occurred'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });
        }

        // Filter handling
        document.getElementById('timeFilter').addEventListener('change', applyFilters);
        document.getElementById('studyType').addEventListener('input', applyFilters);
        document.getElementById('resultType').addEventListener('change', applyFilters);
        document.getElementById('username').addEventListener('change', applyFilters);

        function applyFilters() {
            const timeFilter = document.getElementById('timeFilter').value;
            const studyType = document.getElementById('studyType').value;
            const resultType = document.getElementById('resultType').value;
            const username = getUsername();

            const params = new URLSearchParams();
            if (timeFilter && timeFilter !== 'all') params.append('time_filter', timeFilter);
            if (studyType) params.append('study_type', studyType);
            // Always include result_type parameter, even if empty
            params.append('result_type', resultType);
            if (username) params.append('username', username);

            window.location.href = '/?' + params.toString();
        }

        // Add event listener for result type change
        document.getElementById('resultType').addEventListener('change', function() {
            // Force immediate filter application when result type changes
            applyFilters();
        });

        function resetFilters() {
            const currentUsername = document.getElementById('username').value;
            document.getElementById('timeFilter').value = 'all';
            document.getElementById('studyType').value = '';
            document.getElementById('resultType').value = '';
            window.location.href = '/reset_filters?username=' + encodeURIComponent(currentUsername);
        }

        function expandCommentInput(studyId) {
            document.getElementById('new-comment-input-' + studyId).classList.add('hidden');
            const wrapper = document.getElementById('comment-textarea-wrapper-' + studyId);
            wrapper.classList.remove('hidden');
            const textarea = document.getElementById('new-comment-textarea-' + studyId);
            textarea.value = '';
            textarea.focus();
        }
        function shrinkCommentInput(studyId) {
            document.getElementById('new-comment-input-' + studyId).classList.remove('hidden');
            document.getElementById('comment-textarea-wrapper-' + studyId).classList.add('hidden');
            document.getElementById('new-comment-textarea-' + studyId).value = '';
        }
        function saveComment(studyId) {
            const username = getUsername();
            if (!username) {
                alert('Please select or enter your username before commenting');
                return;
            }
            let text = document.getElementById('new-comment-textarea-' + studyId).value;
            if (!text.trim()) return;
            fetch('/api/comments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ study_id: studyId, username: username, text: text })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    shrinkCommentInput(studyId);
                    loadLatestComment(studyId);
                } else {
                    alert('Virhe: ' + (data.error || 'Tuntematon virhe kommentin tallennuksessa'));
                }
            });
        }
        function loadLatestComment(studyId) {
            fetch('/api/comments?study_id=' + studyId)
            .then(res => res.json())
            .then(comments => {
                const latest = comments && comments.length > 0 ? comments[0] : null;
                const el = document.getElementById('latest-comment-' + studyId);
                if (latest) {
                    el.innerHTML = `<span class='font-semibold'>${latest.user}:</span> ${latest.text}`;
                } else {
                    el.innerHTML = '';
                }
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            {% for study in studies.items %}
            loadLatestComment({{ study.id }});
            {% endfor %}
        });
        // Modal for all comments
        function showAllComments(studyId) {
            fetch('/api/comments?study_id=' + studyId)
            .then(res => res.json())
            .then(comments => {
                const list = document.getElementById('comments-modal-list');
                list.innerHTML = '';
                if (comments.length === 0) {
                    list.innerHTML = '<div class="text-gray-500">Ei kommentteja.</div>';
                } else {
                    comments.forEach(comment => {
                        const div = document.createElement('div');
                        div.className = 'mb-2 p-2 rounded border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900';
                        div.innerHTML = `<span class='font-semibold'>${comment.user}:</span> ${comment.text} <span class='text-xs text-gray-400'>${new Date(comment.created_at).toLocaleString()}</span>`;
                        // Add edit/delete buttons if user matches
                        const username = getUsername();
                        if (username && username.toLowerCase() === comment.user.toLowerCase()) {
                            div.innerHTML += ` <button class='text-blue-600 text-xs' onclick='editComment(${comment.id}, "${comment.text.replace(/"/g, '&quot;')}")'>Muokkaa</button>`;
                            div.innerHTML += ` <button class='text-red-600 text-xs' onclick='deleteComment(${comment.id}, ${studyId})'>Poista</button>`;
                        }
                        list.appendChild(div);
                    });
                }
                document.getElementById('comments-modal').classList.remove('hidden');
            });
        }
        function closeCommentsModal() {
            document.getElementById('comments-modal').classList.add('hidden');
        }
        function editComment(commentId, oldText) {
            const newText = prompt('Muokkaa kommenttia:', oldText);
            if (newText === null) return;
            const username = getUsername();
            fetch(`/api/comments/${commentId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, text: newText })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    closeCommentsModal();
                    // Find the studyId for this comment and reload
                    document.querySelectorAll('[id^="comment-section-"]').forEach(div => {
                        if (div.innerHTML.includes(`editComment(${commentId},`)) {
                            const studyId = div.id.split('-')[2];
                            loadLatestComment(studyId);
                        }
                    });
                } else {
                    alert('Virhe: ' + (data.error || 'Tuntematon virhe kommentin muokkauksessa'));
                }
            });
        }
        function deleteComment(commentId, studyId) {
            const username = getUsername();
            if (!confirm('Haluatko varmasti poistaa tämän kommentin?')) return;
            fetch(`/api/comments/${commentId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    closeCommentsModal();
                    loadLatestComment(studyId);
                } else {
                    alert('Virhe: ' + (data.error || 'Tuntematon virhe kommentin poistossa'));
                }
            });
        }
    </script>
</body>
</html> 