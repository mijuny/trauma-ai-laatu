<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trauma AI laadunvalvonta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#475569',
                    }
                }
            }
        }
    </script>
    <style>
        .dark {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .dark .bg-white {
            background-color: #2d2d2d;
        }
        .dark .text-gray-700 {
            color: #e0e0e0;
        }
        .dark .border-gray-200 {
            border-color: #404040;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Trauma AI laadunvalvonta</h1>
            <div class="space-x-4">
                <button onclick="toggleTheme()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded">Toggle Theme</button>
                <a href="/export" class="px-4 py-2 bg-blue-500 text-white rounded">Export CSV</a>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <select id="timeFilter" class="border rounded p-2">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">Last Week</option>
                    <option value="month">Last Month</option>
                </select>
                <input type="text" id="studyType" placeholder="Study Type" class="border rounded p-2">
                <select id="resultType" class="border rounded p-2">
                    <option value="">All Results</option>
                    <option value="TP">True Positive</option>
                    <option value="TN">True Negative</option>
                    <option value="FP">False Positive</option>
                    <option value="FN">False Negative</option>
                </select>
                <div class="flex items-center space-x-2">
                    <select id="username" class="border rounded p-2 flex-grow">
                        <option value="">Select Username</option>
                        {% for username in usernames %}
                        <option value="{{ username }}" {% if username == selected_username %}selected{% endif %}>{{ username }}</option>
                        {% endfor %}
                    </select>
                    <input type="text" id="newUsername" placeholder="New Username" class="border rounded p-2 flex-grow hidden">
                    <button onclick="toggleNewUsername()" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 rounded">+</button>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Statistics</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="p-4 bg-blue-100 rounded">
                    <h3 class="font-semibold">Total Studies</h3>
                    <p class="text-2xl">{{ total_studies }}</p>
                </div>
                <div class="p-4 bg-green-100 rounded">
                    <h3 class="font-semibold">Total Classifications</h3>
                    <p class="text-2xl">{{ total_classifications }}</p>
                </div>
            </div>
            
            <div class="mt-6">
                <h3 class="font-semibold mb-4">Classification Metrics</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <div class="p-2 bg-green-100 rounded">
                        <h4 class="text-sm font-semibold">True Positives</h4>
                        <p class="text-xl">{{ tp_count }}</p>
                    </div>
                    <div class="p-2 bg-green-100 rounded">
                        <h4 class="text-sm font-semibold">True Negatives</h4>
                        <p class="text-xl">{{ tn_count }}</p>
                    </div>
                    <div class="p-2 bg-red-100 rounded">
                        <h4 class="text-sm font-semibold">False Positives</h4>
                        <p class="text-xl">{{ fp_count }}</p>
                    </div>
                    <div class="p-2 bg-red-100 rounded">
                        <h4 class="text-sm font-semibold">False Negatives</h4>
                        <p class="text-xl">{{ fn_count }}</p>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <h3 class="font-semibold mb-4">Performance Metrics</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">Sensitivity</h4>
                        <p class="text-xl">{{ "%.1f"|format(sensitivity) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">Specificity</h4>
                        <p class="text-xl">{{ "%.1f"|format(specificity) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">Accuracy</h4>
                        <p class="text-xl">{{ "%.1f"|format(accuracy) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">PPV</h4>
                        <p class="text-xl">{{ "%.1f"|format(ppv) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">NPV</h4>
                        <p class="text-xl">{{ "%.1f"|format(npv) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">F1 Score</h4>
                        <p class="text-xl">{{ "%.1f"|format(f1_score) }}%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Studies Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Accession Number</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Study Description</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AI Classification</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User Classification</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for study in studies %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">{{ study.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ study.accession_number }}</td>
                        <td class="px-6 py-4">{{ study.study_description }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if study.ai_classification in ['TP', 'FP'] %}
                                POSITIVE
                            {% elif study.ai_classification in ['TN', 'FN'] %}
                                NEGATIVE
                            {% else %}
                                {{ study.ai_classification }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if study.classifications %}
                                {% if study.classifications[-1].classification in ['TP', 'FN'] %}
                                    POSITIVE
                                {% elif study.classifications[-1].classification in ['TN', 'FP'] %}
                                    NEGATIVE
                                {% else %}
                                    {{ study.classifications[-1].classification }}
                                {% endif %}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select onchange="classifyStudy({{ study.id }}, this.value)" class="border rounded p-1">
                                <option value="">Select Classification</option>
                                <option value="POSITIVE" {% if study.classifications and study.classifications[-1].classification in ['TP', 'FN'] %}selected{% endif %}>Positive</option>
                                <option value="NEGATIVE" {% if study.classifications and study.classifications[-1].classification in ['TN', 'FP'] %}selected{% endif %}>Negative</option>
                            </select>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function toggleTheme() {
            document.body.classList.toggle('dark');
        }

        function toggleNewUsername() {
            const usernameSelect = document.getElementById('username');
            const newUsernameInput = document.getElementById('newUsername');
            
            if (newUsernameInput.classList.contains('hidden')) {
                usernameSelect.classList.add('hidden');
                newUsernameInput.classList.remove('hidden');
                newUsernameInput.focus();
                
                // Add enter key handler when showing the input
                newUsernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const username = newUsernameInput.value.trim();
                        if (username) {
                            // Check if username already exists
                            const existingUsernames = Array.from(usernameSelect.options).map(opt => opt.value.toLowerCase());
                            if (existingUsernames.includes(username.toLowerCase())) {
                                alert('This username already exists. Please choose a different one.');
                                return;
                            }
                            
                            // Add username to database
                            fetch('/api/username', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ username: username })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    // Add the new username to the dropdown
                                    const option = document.createElement('option');
                                    option.value = username;
                                    option.text = username;
                                    usernameSelect.appendChild(option);
                                    usernameSelect.value = username;
                                    
                                    // Switch back to dropdown
                                    toggleNewUsername();
                                    
                                    // Apply filters with new username
                                    applyFilters();
                                } else {
                                    alert('Error: ' + data.error);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('An error occurred while adding the username');
                            });
                        }
                    }
                });
            } else {
                usernameSelect.classList.remove('hidden');
                newUsernameInput.classList.add('hidden');
                newUsernameInput.value = '';
            }
        }

        function getUsername() {
            const usernameSelect = document.getElementById('username');
            const newUsernameInput = document.getElementById('newUsername');
            
            if (!newUsernameInput.classList.contains('hidden')) {
                return newUsernameInput.value.trim();
            }
            return usernameSelect.value;
        }

        function classifyStudy(studyId, classification) {
            if (!classification) return;
            
            const username = getUsername();
            if (!username) {
                alert('Please select or enter your username before classifying');
                return;
            }

            if (!confirm('Are you sure you want to classify this study as ' + classification + '?')) {
                return;
            }

            fetch('/api/classify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    study_id: studyId,
                    username: username,
                    classification: classification
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to classify study');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error occurred'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });
        }

        // Filter handling
        document.getElementById('timeFilter').addEventListener('change', applyFilters);
        document.getElementById('studyType').addEventListener('input', applyFilters);
        document.getElementById('resultType').addEventListener('change', applyFilters);
        document.getElementById('username').addEventListener('change', applyFilters);

        function applyFilters() {
            const timeFilter = document.getElementById('timeFilter').value;
            const studyType = document.getElementById('studyType').value;
            const resultType = document.getElementById('resultType').value;
            const username = getUsername();

            const params = new URLSearchParams();
            if (timeFilter) params.append('time_filter', timeFilter);
            if (studyType) params.append('study_type', studyType);
            if (resultType) params.append('result_type', resultType);
            if (username) params.append('username', username);

            window.location.href = '/?' + params.toString();
        }
    </script>
</body>
</html> 