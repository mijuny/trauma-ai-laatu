<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t('title') }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#475569',
                    }
                }
            }
        }
    </script>
    <style>
        .dark {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .dark .bg-white {
            background-color: #2d2d2d;
        }
        .dark .text-gray-700 {
            color: #e0e0e0;
        }
        .dark .border-gray-200 {
            border-color: #404040;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">{{ t('title') }}</h1>
            <div class="space-x-4">
                <select onchange="window.location.href='/set_language/' + this.value" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded">
                    <option value="fi" {% if lang == 'fi' %}selected{% endif %}>Suomi</option>
                    <option value="en" {% if lang == 'en' %}selected{% endif %}>English</option>
                </select>
                <button onclick="toggleTheme()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded">{{ t('toggle_theme') }}</button>
                <a href="/export" class="px-4 py-2 bg-blue-500 text-white rounded">{{ t('export_csv') }}</a>
            </div>
        </div>

        <!-- Statistics -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">{{ t('statistics') }}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="p-4 bg-blue-100 rounded">
                    <h3 class="font-semibold">{{ t('total_studies') }}</h3>
                    <p class="text-2xl">{{ total_studies }}</p>
                </div>
                <div class="p-4 bg-green-100 rounded">
                    <h3 class="font-semibold">{{ t('total_classifications') }}</h3>
                    <p class="text-2xl">{{ total_classifications }}</p>
                </div>
            </div>
            
            <div class="mt-6">
                <h3 class="font-semibold mb-4">{{ t('classification_metrics') }}</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <div class="p-2 bg-green-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('true_positive') }}</h4>
                        <p class="text-xl">{{ tp_count }}</p>
                    </div>
                    <div class="p-2 bg-green-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('true_negative') }}</h4>
                        <p class="text-xl">{{ tn_count }}</p>
                    </div>
                    <div class="p-2 bg-red-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('false_positive') }}</h4>
                        <p class="text-xl">{{ fp_count }}</p>
                    </div>
                    <div class="p-2 bg-red-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('false_negative') }}</h4>
                        <p class="text-xl">{{ fn_count }}</p>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <h3 class="font-semibold mb-4">{{ t('performance_metrics') }}</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('sensitivity') }}</h4>
                        <p class="text-xl">{{ "%.1f"|format(sensitivity) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('specificity') }}</h4>
                        <p class="text-xl">{{ "%.1f"|format(specificity) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('accuracy') }}</h4>
                        <p class="text-xl">{{ "%.1f"|format(accuracy) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('ppv') }}</h4>
                        <p class="text-xl">{{ "%.1f"|format(ppv) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('npv') }}</h4>
                        <p class="text-xl">{{ "%.1f"|format(npv) }}%</p>
                    </div>
                    <div class="p-2 bg-blue-100 rounded">
                        <h4 class="text-sm font-semibold">{{ t('f1_score') }}</h4>
                        <p class="text-xl">{{ "%.1f"|format(f1_score) }}%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">{{ t('filters') }}</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <select id="timeFilter" class="border rounded p-2">
                    <option value="all">{{ t('all_time') }}</option>
                    <option value="today">{{ t('today') }}</option>
                    <option value="week">{{ t('last_week') }}</option>
                    <option value="month">{{ t('last_month') }}</option>
                </select>
                <input type="text" id="studyType" placeholder="{{ t('study_type') }}" class="border rounded p-2">
                <select id="resultType" class="border rounded p-2">
                    <option value="">{{ t('all_results') }}</option>
                    <option value="TP" {% if result_type == 'TP' %}selected{% endif %}>{{ t('true_positive') }}</option>
                    <option value="TN" {% if result_type == 'TN' %}selected{% endif %}>{{ t('true_negative') }}</option>
                    <option value="FP" {% if result_type == 'FP' %}selected{% endif %}>{{ t('false_positive') }}</option>
                    <option value="FN" {% if result_type == 'FN' %}selected{% endif %}>{{ t('false_negative') }}</option>
                </select>
                <div class="flex items-center space-x-2">
                    <select id="username" class="border rounded p-2 flex-grow">
                        <option value="">{{ t('select_username') }}</option>
                        {% for username in usernames %}
                        <option value="{{ username }}" {% if username == selected_username %}selected{% endif %}>{{ username }}</option>
                        {% endfor %}
                    </select>
                    <input type="text" id="newUsername" placeholder="{{ t('new_username') }}" class="border rounded p-2 flex-grow hidden">
                    <button onclick="toggleNewUsername()" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 rounded">+</button>
                </div>
            </div>
            <div class="mt-4">
                <button onclick="resetFilters()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">
                    {{ t('reset_filters') }}
                </button>
            </div>
        </div>

        <!-- Studies Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('date') }}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('accession_number') }}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('study_description') }}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('ai_classification') }}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('user_classification') }}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('actions') }}</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for study in studies %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">{{ study.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ study.accession_number }}</td>
                        <td class="px-6 py-4">{{ study.study_description }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if study.ai_classification in ['TP', 'FP'] %}
                                {{ t('positive') }}
                            {% elif study.ai_classification in ['TN', 'FN'] %}
                                {{ t('negative') }}
                            {% elif study.ai_classification == 'DOUBT' %}
                                {{ t('doubt') }}
                            {% else %}
                                {{ study.ai_classification }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if study.classifications %}
                                {% if study.classifications[-1].classification in ['TP', 'FN'] %}
                                    {{ t('positive') }}
                                {% elif study.classifications[-1].classification in ['TN', 'FP'] %}
                                    {{ t('negative') }}
                                {% else %}
                                    {{ study.classifications[-1].classification }}
                                {% endif %}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select onchange="classifyStudy({{ study.id }}, this.value)" class="border rounded p-1">
                                <option value="">{{ t('select_classification') }}</option>
                                <option value="POSITIVE" {% if study.classifications and study.classifications[-1].classification in ['TP', 'FN'] %}selected{% endif %}>{{ t('positive') }}</option>
                                <option value="NEGATIVE" {% if study.classifications and study.classifications[-1].classification in ['TN', 'FP'] %}selected{% endif %}>{{ t('negative') }}</option>
                            </select>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function toggleTheme() {
            document.body.classList.toggle('dark');
        }

        function toggleNewUsername() {
            const usernameSelect = document.getElementById('username');
            const newUsernameInput = document.getElementById('newUsername');
            
            if (newUsernameInput.classList.contains('hidden')) {
                usernameSelect.classList.add('hidden');
                newUsernameInput.classList.remove('hidden');
                newUsernameInput.focus();
                
                // Add enter key handler when showing the input
                newUsernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const username = newUsernameInput.value.trim();
                        if (username) {
                            // Check if username already exists
                            const existingUsernames = Array.from(usernameSelect.options).map(opt => opt.value.toLowerCase());
                            if (existingUsernames.includes(username.toLowerCase())) {
                                alert('This username already exists. Please choose a different one.');
                                return;
                            }
                            
                            // Add username to database
                            fetch('/api/username', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ username: username })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    // Add the new username to the dropdown
                                    const option = document.createElement('option');
                                    option.value = username;
                                    option.text = username;
                                    usernameSelect.appendChild(option);
                                    usernameSelect.value = username;
                                    
                                    // Switch back to dropdown
                                    toggleNewUsername();
                                    
                                    // Apply filters with new username
                                    applyFilters();
                                } else {
                                    alert('Error: ' + data.error);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('An error occurred while adding the username');
                            });
                        }
                    }
                });
            } else {
                usernameSelect.classList.remove('hidden');
                newUsernameInput.classList.add('hidden');
                newUsernameInput.value = '';
            }
        }

        function getUsername() {
            const usernameSelect = document.getElementById('username');
            const newUsernameInput = document.getElementById('newUsername');
            
            if (!newUsernameInput.classList.contains('hidden')) {
                return newUsernameInput.value.trim();
            }
            return usernameSelect.value;
        }

        function classifyStudy(studyId, classification) {
            if (!classification) return;
            
            const username = getUsername();
            if (!username) {
                alert('Please select or enter your username before classifying');
                return;
            }

            if (!confirm('Are you sure you want to classify this study as ' + classification + '?')) {
                return;
            }

            fetch('/api/classify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    study_id: studyId,
                    username: username,
                    classification: classification
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to classify study');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error occurred'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });
        }

        // Filter handling
        document.getElementById('timeFilter').addEventListener('change', applyFilters);
        document.getElementById('studyType').addEventListener('input', applyFilters);
        document.getElementById('resultType').addEventListener('change', applyFilters);
        document.getElementById('username').addEventListener('change', applyFilters);

        function applyFilters() {
            const timeFilter = document.getElementById('timeFilter').value;
            const studyType = document.getElementById('studyType').value;
            const resultType = document.getElementById('resultType').value;
            const username = getUsername();

            const params = new URLSearchParams();
            if (timeFilter && timeFilter !== 'all') params.append('time_filter', timeFilter);
            if (studyType) params.append('study_type', studyType);
            // Always include result_type parameter, even if empty
            params.append('result_type', resultType);
            if (username) params.append('username', username);

            window.location.href = '/?' + params.toString();
        }

        // Add event listener for result type change
        document.getElementById('resultType').addEventListener('change', function() {
            // Force immediate filter application when result type changes
            applyFilters();
        });

        function resetFilters() {
            document.getElementById('timeFilter').value = 'all';
            document.getElementById('studyType').value = '';
            document.getElementById('resultType').value = '';
            document.getElementById('username').value = '';
            window.location.href = '/reset_filters';
        }
    </script>
</body>
</html> 